######################################################
# Template Makefile that can be used for compiling   #
# both the input C program and the OpenARC-generated #
# output C++ program.                                #
######################################################

##########################################################
# Available Make targets                                 #
##########################################################
# CPU: compile C program using a given C compiler        #
# CPU2: compile C/C++ program using a given C++ compiler #
# TCPU: compile OpenARC-generated C++ program            #
# ACC: compile OpenARC-generated CUDA/OpenCL program     #
# COMPILE_HOST: compile the host part of                 #
#               OpenARC-generated CUDA/OpenCL program    #              
# COMPILE_KERNEL: compile the kernel part of             # 
#                 OpenARC-generated CUDA/OpenCL program  #                
# LLVM: compile nvl-C program                            #
##########################################################
.PHONY: ACC CPU CPU2 TCPU LLVM all COMPILE_HOST COMPILE_KERNEL makedirectories help
ACC: $(BENCHMARK)_ACC
CPU: $(BENCHMARK)_CPU
CPU2: $(BENCHMARK)_CPU2
TCPU: $(BENCHMARK)_TCPU
LLVM: $(BENCHMARK)_LLVM
all: ACC CPU
help:
	@echo "==> Available make targets:"
	@echo "CPU: compile a C program using a given C compiler"
	@echo "CPU2: compile a C/C++ program using a given C++ compiler"
	@echo "TCPU: compile an OpenARC-generated C++ program"
	@echo "ACC: compile an OpenARC-generated CUDA/OpenCL program"
	@echo "COMPILE_HOST: compile the host part of an OpenARC-generated CUDA/OpenCL program"
	@echo "COMPILE_KERNEL: compile the kernel part of an OpenARC-generated CUDA/OpenCL program"
	@echo "LLVM: compile an nvl-C program"

##########################################################
# Makefile options that the user can overwrite           #
##########################################################
# OMP: set to 1 to use OpenMP (default: 0)               # 
# MODE: set to profile to use a built-in profiling tool  #
#       (default: normal)                                #
#       If this is set to profile, the runtime system    #
#       will print profiling results according to the    #
#       verbosity level set by OPENARCRT_VERBOSITY       #
#       environment variable.                            # 
# DIST: set to 1 to use Integrated Message Passing       #
#       OpenACC (IMPACC) version                         #
#       (default: 0)                                     #
# AOCL_FLAGS: set Altera OpenCL Compiler (AOC) flags     #
#    - commonly used options                             #
#      -march=emulator //compile a kernel for emulation  #
#      -v //show progress of the compilation on-screen   # 
#      -c //compile the kernel and generate a Quartus II #
#         //hardware design project without creating a   #
#         //hardware configuration file.                 #
#      --profile //instrument the OpenCL kernel pipeline #
#                //with performance counters.            #
#      --report  //display estimated resource usage on   #
#                //the screen.                           #
#    (default: -march=emulator)                          #
# AOCL_BOARD: set a target Altera FPGA board             #
#    - "--board $(AOCL_BOARD)" will be added to the AOC  #
#     in addition to the above flags                     # 
#    - Examples                                          #
#    p385_hpc_d5 //for Stratix V (default)               #
#    p510t_sch_ax115 //for Arria 10 (Nallatech 510T)     #
# POSTCMD: optional commands to be executed after the    #
#    main compilation                                    #
##########################################################
OMP ?= 0
MODE ?= normal
DIST ?= 0
AOCL_BOARD ?= p385_hpc_d5
AOCL_FLAGS ?= -march=emulator

ifeq ($(DIST),1)
#OMP should be set to 1 to use IMPACC version.
OMP = 1
endif

########################
# Set the program name #
########################
#BENCHMARK = openaccbenchmark 

########################################
# Set the input C source files (CSRCS) #
########################################
#CSRCS = matmul.c
CXXSRCS1 = $(CSRCS:.c=.cpp)
CXXSRCS = $(notdir $(CXXSRCS1))

#########################################
# Set macros used for the input program #
#########################################
DEFSET_CPU += -DOMP=$(OMP)
DEFSET_LLVM += -DOMP=$(OMP)
DEFSET_ACC += -DOMP=$(OMP)

#########################################################
# Use the following macros to add program-specific      #
# compiler flags and libraries                          #
# - CFLAGS1 and CLIBS1 to compile the input C program   #
#   - To use relative paths, assume that the directory  #
#   containing the Makefile is the current directory.   #
# - CFLAGS2 and CLIBS2 to compile the OpenARC-generated #
#   output C++ program                                  # 
#   - To use relative paths, assume that cetus_output   #
#   is the current directory.                           #
#########################################################
#CFLAGS1 =  
#CFLAGS1_LLVM =  
#CFLAGS2 =  
#CLIBS1 = 
#CLIBS1_LLVM = 
#CLIBS2 = 

################################################
# TARGET is where the output binary is stored. #
################################################
TARGET ?= ./bin

##############################
# Set the output binary name #
##############################
BENCHMARK_OPENACC = $(TARGET)/$(BENCHMARK)_ACC
BENCHMARK_CPU = $(TARGET)/$(BENCHMARK)_CPU
BENCHMARK_CPU2 = $(TARGET)/$(BENCHMARK)_CPU2
BENCHMARK_TCPU = $(TARGET)/$(BENCHMARK)_TCPU
BENCHMARK_LLVM = $(TARGET)/$(BENCHMARK)_LLVM

####################
# Compiler options #
####################
COMMONCFLAGS = $(GMACROS) $(GFRONTEND_FLAGS)
COMMONCLIBS = $(GFRONTEND_LIBS) 
COMMONCINCLUDES = $(GFRONTEND_INCLUDES)
ifeq ($(OPENARC_ARCH),0)
# CUDA target
OPENARCLIB_SUFFIX = cuda
KERNEL_FILE = openarc_kernel.cu
RESILIENCE_FILE = resilience.cu
else
# OpenCL target
OPENARCLIB_SUFFIX = opencl
KERNEL_FILE = openarc_kernel.cl
RESILIENCE_FILE = resilience.cl
endif

ifeq ($(OPENARC_ARCH),3)
#EMUL_MODE = $(shell export $(AOCL_FLAGS); echo $$AOCL_FLAGS | grep "emulator" > /dev/null 2>&1;)
EMUL_MODE = $(shell export AOCL_FLAGS="$(AOCL_FLAGS)"; echo $$AOCL_FLAGS | grep "emulator";)
ifneq ($(EMUL_MODE),)
    KERNEL_BINARY ?= "openarc_kernel_EmulatorDeviceEmulatedDevice.aocx"
else
    KERNEL_BINARY ?= "openarc_kernel_p385_hpc_d5PCIe385n.aocx"
endif
endif

ifeq ($(OMP),1)
CLIBS1_BASE = $(GOMP_LIBS)
CLIBS2_BASE = $(COMMONCLIBS) $(GOMP_LIBS)
OMP_FLAGS1 = $(GOMP_FLAGS)
ifneq ($(GOMP_FLAGS),"")
OMP_FLAGS2 = $(GOMP_FLAGS)
endif
ifeq ($(DIST),1)
ACCRT_BASE = openaccrtdist_$(OPENARCLIB_SUFFIX)
else
ACCRT_BASE = openaccrtomp_$(OPENARCLIB_SUFFIX)
endif
else
CLIBS1_BASE = 
CLIBS2_BASE = $(COMMONCLIBS)
OMP_FLAGS1 =
OMP_FLAGS2 =
ACCRT_BASE = openaccrt_$(OPENARCLIB_SUFFIX)
endif

# Compiler flags 
CFLAGS1 += $(OMP_FLAGS1) -I$(OPENARCLIB)
CFLAGS1_LLVM += $(OMP_FLAGS1) -I$(OPENARCLIB)
CFLAGS2 += -D_OPENACC=201306
ifeq ($(MODE),profile)
CFLAGS2 += $(GFRONTEND_DEBUG) $(OMP_FLAGS2) $(COMMONCINCLUDES)
ACCRTLIB = $(ACCRT_BASE)pf
else
CFLAGS2 += $(COMMONCFLAGS) $(OMP_FLAGS2) $(COMMONCINCLUDES)
ACCRTLIB = $(ACCRT_BASE)
endif

# Libraries
CLIBS1 += $(CLIBS1_BASE) -L$(OPENARCLIB) 
CLIBS1_LLVM += -L$(OPENARCLIB) 
CLIBS2 += $(CLIBS2_BASE) -l$(ACCRTLIB) -lomphelper

$(BENCHMARK)_CPU: $(CSRCS) makedirectories
	$(CC) $(DEFSET_CPU) $(CFLAGS1) -o $(BENCHMARK_CPU) $(CSRCS) $(CLIBS1)
	$(POSTCMD)

$(BENCHMARK)_CPU2: $(CSRCS) makedirectories
	$(CXX) $(DEFSET_CPU) $(CFLAGS1) -o $(BENCHMARK_CPU2) $(CSRCS) $(CLIBS1)
	$(POSTCMD)

$(BENCHMARK)_TCPU: $($(CETUS_OUTPUT)/$(CSRCS)) makedirectories
	cd $(CETUS_OUTPUT); $(CXX) $(DEFSET_CPU) $(CFLAGS1) -I ../ -o ../$(BENCHMARK_TCPU) $(CSRCS) $(CLIBS1); cd ../
	$(POSTCMD)

$(BENCHMARK)_LLVM: $(CSRCS) makedirectories
	$(OPENARCLIB)/../bin/openarc-cc $(DEFSET_LLVM) $(CFLAGS1_LLVM) -o $(BENCHMARK_LLVM) $(CSRCS) $(CLIBS1_LLVM)
	$(POSTCMD)

$(BENCHMARK)_ACC: COMPILE_HOST COMPILE_KERNEL
	$(POSTCMD)

COMPILE_HOST: $($(CETUS_OUTPUT)/$(CXXSRCS)) makedirectories
	cd $(CETUS_OUTPUT); $(CXX) $(DEFSET_ACC) $(CFLAGS2) -I ../ -o ../$(BENCHMARK_OPENACC) $(CXXSRCS) $(CLIBS2); cp $(KERNEL_FILE) ../$(TARGET); if [ -f "$(OPENARCLIB)/binBuilder_$(OPENARCLIB_SUFFIX)" ]; then cp $(OPENARCLIB)/binBuilder_$(OPENARCLIB_SUFFIX) ../$(TARGET); fi; cp $(OPENARCLIB)/Timer ../$(TARGET); cd ../
	cd $(CETUS_OUTPUT); grep resilience $(KERNEL_FILE) > /dev/null && cp $(OPENARCLIB)/$(RESILIENCE_FILE) $(OPENARCLIB)/resilience.h ../$(TARGET); cd ../

COMPILE_KERNEL: $($(CETUS_OUTPUT)/$(KERNLE_FILE)) makedirectories
	if [ "$(OPENARC_ARCH)" = "3" ]; then cd $(CETUS_OUTPUT); aoc $(AOCL_FLAGS) --board $(AOCL_BOARD) openarc_kernel.cl; if [ -f "openarc_kernel.aocx" ]; then cp openarc_kernel.aocx ../$(TARGET)/$(KERNEL_BINARY); fi; cd ../; echo ""; echo "====> Initialize AOCL Environment!"; echo "$$ . $$alteraroot/init_opencl.sh"; echo ""; fi
	if [ "$(OPENARC_ARCH)" != "3" ] && [ -f $(TARGET)/binBuilder_$(OPENARCLIB_SUFFIX) ]; then cd $(TARGET); ./binBuilder_$(OPENARCLIB_SUFFIX); cd ../; fi

makedirectories:
	mkdir -p $(TARGET)

clean:
	rm -f *.o *.bc *~ confFile.txt Makefile*.local TuningOptions.txt;
	if [ -d ./$(CETUS_OUTPUT) ]; then cd $(CETUS_OUTPUT); rm -rf *.o *~ *aoco *aocx openarc_kernel; cd ..; fi
	if [ -d $(TARGET) ]; then rm -f $(BENCHMARK_CPU) $(BENCHMARK_CPU2) $(BENCHMARK_TCPU) $(BENCHMARK_LLVM) $(BENCHMARK_OPENACC) Timer; cd $(TARGET); rm -f openarc_kernel*.ptx $(KERNEL_FILE) binBuilder_$(OPENARCLIB_SUFFIX) Timer *.aocx; fi

purge: clean
	rm -rf $(TARGET) $(CETUS_OUTPUT) cetus_input openarcConf.txt *.log
